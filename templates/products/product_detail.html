{% extends 'base.html' %}
{% load static %}
{% block title %}{{product.product_name}} - Premium Selection{% endblock %}

{% block content %}
<style>
  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
  }
  
  .yellow-accent-bg {
    background-color: #fde047;
  }
  
  .yellow-accent-text {
    color: #fde047;
  }
  
  .yellow-accent-border {
    border-color: #fde047;
  }
  
  .yellow-accent-hover:hover {
    background-color: #facc15;
  }
  
  .gallery-thumbnail {
    transition: all 0.3s ease;
    border: 2px solid transparent;
  }
  
  .gallery-thumbnail:hover {
    transform: scale(1.05);
    border-color: #fde047;
  }
  
  .gallery-thumbnail.active {
    border-color: #fde047;
    box-shadow: 0 0 0 2px rgba(253, 224, 71, 0.3);
  }
  
  .star-rating {
    direction: rtl;
    display: inline-flex;
  }
  
  .star-rating input {
    display: none;
  }
  
  .star-rating label {
    cursor: pointer;
    color: #d1d5db;
    transition: color 0.2s;
  }
  
  .star-rating input:checked ~ label,
  .star-rating label:hover,
  .star-rating label:hover ~ label {
    color: #f59e0b;
  }
  
  .stock-indicator {
    position: relative;
    height: 6px;
    background-color: #f3f4f6;
    border-radius: 3px;
    overflow: hidden;
  }
  
  .stock-indicator::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    width: calc(100% * var(--stock-level));
    background-color: var(--stock-color);
    transition: width 0.6s ease;
  }
  
  .review-progress {
    height: 6px;
    background-color: #f3f4f6;
    border-radius: 3px;
    overflow: hidden;
  }
  
  .review-progress-bar {
    height: 100%;
    background-color: #f59e0b;
  }
  
  .product-tab {
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
  }
  
  .product-tab:hover {
    color: #111827;
    border-bottom-color: #fde047;
  }
  
  .product-tab.active {
    color: #111827;
    border-bottom-color: #fde047;
    font-weight: 600;
  }
  
  @media (max-width: 768px) {
    .sticky-product-info {
      position: static;
      top: auto;
    }
  }
</style>

<div class="bg-gray-50 min-h-screen">
  <!-- Breadcrumb Navigation -->
  <div class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <nav class="flex" aria-label="Breadcrumb">
        <ol class="flex items-center space-x-4">
          <li>
            <div>
              <a href="{% url 'home' %}" class="text-gray-400 hover:text-gray-500">
                <svg class="flex-shrink-0 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                  <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" />
                </svg>
                <span class="sr-only">Home</span>
              </a>
            </div>
          </li>
          <li>
            <div class="flex items-center">
              <svg class="flex-shrink-0 h-5 w-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
              </svg>
              <a href="{% url 'category_products' product.category.slug %}" class="ml-4 text-sm font-medium text-gray-500 hover:text-gray-700">{{ product.category.category_name }}</a>
            </div>
          </li>
          <li>
            <div class="flex items-center">
              <svg class="flex-shrink-0 h-5 w-5 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path d="M5.555 17.776l8-16 .894.448-8 16-.894-.448z" />
              </svg>
              <span class="ml-4 text-sm font-medium text-gray-500">{{ product.product_name }}</span>
            </div>
          </li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Main Product Section -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div class="lg:grid lg:grid-cols-2 lg:gap-12 xl:gap-16">
      <!-- Image Gallery -->
      <div class="mb-10 lg:mb-0">
        <div class="relative rounded-2xl bg-white p-6 shadow-xl mb-6 overflow-hidden">
          <!-- Badges -->
          {% if product.created|timesince|slice:":2" <= "2" %}
          <div class="absolute top-6 left-6 z-10 bg-yellow-500 text-gray-900 text-xs font-bold px-3 py-1 rounded-full shadow-md">
            NEW ARRIVAL
          </div>
          {% endif %}
          
          {% if product.discount %}
          <div class="absolute top-6 right-6 z-10 bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">
            {% if product.discount_type == 'percent' %}
            -{{ product.discount }}% OFF
            {% else %}
            SPECIAL OFFER
            {% endif %}
          </div>
          {% endif %}
          
          <img 
            src="{{product.image.url}}" 
            alt="{{product.product_name}}"
            class="w-full h-96 object-contain transition-opacity duration-300 mx-auto"
            id="main-image"
            loading="lazy"
          />
        </div>

        {% if gallery %}
        <div class="mt-6 grid grid-cols-4 gap-4 sm:gap-6">
          {% for i in gallery %}
          <button 
            class="gallery-thumbnail relative group p-2 bg-white rounded-xl shadow-sm overflow-hidden"
            onclick="document.getElementById('main-image').src = '{{i.image.url}}'; 
                     document.querySelectorAll('.gallery-thumbnail').forEach(el => el.classList.remove('active'));
                     this.classList.add('active');"
            {% if forloop.first %}class="active"{% endif %}
          >
            <div class="aspect-square bg-gray-50 rounded-lg overflow-hidden">
              <img 
                src="{{i.image.url}}" 
                alt="{{product.product_name}}"
                class="w-full h-full object-contain group-hover:opacity-90 transition-opacity"
                loading="lazy"
              />
            </div>
          </button>
          {% endfor %}
        </div>
        {% endif %}
      </div>

      <!-- Product Info -->
      <div class="sticky-product-info top-8">
        <div class="bg-white p-8 rounded-2xl shadow-xl">
          <div class="flex justify-between items-start">
            <h1 class="text-3xl font-bold text-gray-900">{{product.product_name}}</h1>
            
            <!-- Wishlist Button -->
            <button class="p-2 text-gray-400 hover:text-red-500 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
              </svg>
            </button>
          </div>
          
          <!-- Rating -->
          <div class="mt-4 flex items-center">
            <div class="flex items-center">
              {% for i in "12345" %}
              <svg class="w-5 h-5 {% if forloop.counter <= product.average_review|add:0 %}text-amber-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
              </svg>
              {% endfor %}
            </div>
            <span class="ml-2 text-sm text-gray-500">({{ product.count_review }} reviews)</span>
            <a href="#reviews" class="ml-4 text-sm font-medium text-indigo-600 hover:text-indigo-500">View all reviews</a>
          </div>

          <!-- Price -->
          <div class="mt-6">
            <div class="flex items-baseline gap-4">
              <p class="text-4xl font-bold text-gray-900">${{product.get_final_price}}</p>
              {% if product.discount %}
              <p class="text-lg text-gray-400 line-through">${{product.price}}</p>
              {% if product.discount_type == 'percent' %}
              <span class="ml-2 text-sm yellow-accent-bg text-gray-900 font-bold px-2 py-1 rounded-full">
                Save {{ product.discount }}%
              </span>
              {% endif %}
              {% endif %}
            </div>
            <p class="mt-2 text-sm text-gray-500">Tax included. Shipping calculated at checkout.</p>
          </div>

          <!-- Stock Indicator -->
          <div class="mt-6">
            {% with stock_level=product.stock|default:0 %}
            <div class="flex items-center justify-between text-sm text-gray-500 mb-2">
              <span>Availability</span>
              <span class="font-medium {% if stock_level > 10 %}text-green-600{% elif stock_level > 0 %}text-yellow-600{% else %}text-red-600{% endif %}">
                {% if stock_level > 10 %}
                In Stock ({{ stock_level }} available)
                {% elif stock_level > 0 %}
                Only {{ stock_level }} left - Order soon
                {% else %}
                Out of Stock
                {% endif %}
              </span>
            </div>
            <div class="stock-indicator mb-4" 
                 style="--stock-level: {% widthratio stock_level 100 100 %}; 
                        --stock-color: {% if stock_level > 50 %}#10B981{% elif stock_level > 20 %}#F59E0B{% else %}#EF4444{% endif %};">
            </div>
            {% endwith %}
          </div>

          <!-- Variations -->
          {% for category in variation_categories %}
          <div class="mt-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">{{ category.display_name }}</label>
            <div class="grid grid-cols-4 gap-3">
              {% for variation in variations %}
                {% if variation.variation_category == category %}
                <button 
                  type="button"
                  class="py-2 px-3 border rounded-md text-sm font-medium text-center {% if forloop.first %}yellow-accent-bg text-gray-900 border-yellow-500{% else %}bg-white text-gray-700 border-gray-300 hover:bg-gray-50{% endif %}"
                >
                  {{ variation.variation_value }}
                </button>
                {% endif %}
              {% endfor %}
            </div>
          </div>
          {% endfor %}

          <!-- Actions -->
          <div class="mt-8 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <button 
              type="button"
              class="yellow-accent-bg yellow-accent-hover text-gray-900 font-bold px-6 py-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 flex items-center justify-center"
              onclick="window.location.href='{% url 'add_cart' product.id %}'"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
              </svg>
              Add to Cart
            </button>
            <button 
              type="button"
              class="bg-gray-900 hover:bg-gray-800 text-white font-bold px-6 py-4 rounded-xl shadow-lg transition duration-300 transform hover:scale-105 flex items-center justify-center"
              onclick="window.location.href='{% url 'place_order' %}'"
            >
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
              </svg>
              Buy Now
            </button>
          </div>

          <!-- Highlights -->
          <div class="mt-8 border-t border-gray-200 pt-6">
            <h3 class="text-sm font-medium text-gray-900">Highlights</h3>
            <div class="mt-4">
              <ul class="list-disc pl-5 space-y-2 text-sm text-gray-600">
                <li>Premium quality materials</li>
                <li>Handcrafted with attention to detail</li>
                <li>30-day satisfaction guarantee</li>
                <li>Free shipping on orders over $50</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Product Tabs -->
        <div class="mt-8">
          <div class="border-b border-gray-200">
            <nav class="-mb-px flex space-x-8">
              <button 
                id="description-tab"
                class="product-tab active whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-500"
                onclick="showTab('description')"
              >
                Description
              </button>
              <button 
                id="specs-tab"
                class="product-tab whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-500"
                onclick="showTab('specs')"
              >
                Specifications
              </button>
              <button 
                id="reviews-tab"
                class="product-tab whitespace-nowrap py-4 px-1 text-sm font-medium text-gray-500"
                onclick="showTab('reviews')"
              >
                Reviews ({{ product.count_review }})
              </button>
            </nav>
          </div>
        </div>

        <!-- Tab Contents -->
        <div class="mt-6">
          <!-- Description Tab -->
          <div id="description-content" class="tab-content bg-white p-8 rounded-2xl shadow-xl">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Product Details</h2>
            <div class="prose max-w-none text-gray-500">
              {{product.description|safe}}
            </div>
          </div>

          <!-- Specifications Tab -->
          <div id="specs-content" class="tab-content hidden bg-white p-8 rounded-2xl shadow-xl">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Technical Specifications</h2>
            <div class="space-y-4">
              <div class="border-b border-gray-200 pb-4">
                <h3 class="text-sm font-medium text-gray-900">Dimensions</h3>
                <p class="mt-1 text-sm text-gray-600">10.2 x 7.8 x 2.4 inches (25.9 x 19.8 x 6.1 cm)</p>
              </div>
              <div class="border-b border-gray-200 pb-4">
                <h3 class="text-sm font-medium text-gray-900">Weight</h3>
                <p class="mt-1 text-sm text-gray-600">2.2 pounds (1 kg)</p>
              </div>
              <div class="border-b border-gray-200 pb-4">
                <h3 class="text-sm font-medium text-gray-900">Materials</h3>
                <p class="mt-1 text-sm text-gray-600">Premium grade materials with eco-friendly finishes</p>
              </div>
              <div>
                <h3 class="text-sm font-medium text-gray-900">Warranty</h3>
                <p class="mt-1 text-sm text-gray-600">2-year limited manufacturer warranty</p>
              </div>
            </div>
          </div>

          <!-- Reviews Tab -->
          <div id="reviews-content" class="tab-content hidden bg-white p-8 rounded-2xl shadow-xl">
            <h2 id="reviews" class="text-xl font-semibold text-gray-900 mb-6">Customer Reviews</h2>
            
            <!-- Review Summary -->
            <div class="space-y-4 mb-8">
              {% for rating, percentage in review_summary.items %}
              <div class="flex items-center">
                <span class="w-12 text-sm font-medium text-gray-900">{{ rating }} Star</span>
                <div class="flex-1 mx-4">
                  <div class="review-progress">
                    <div class="review-progress-bar" style="width: {{ percentage }}%"></div>
                  </div>
                </div>
                <span class="w-12 text-right text-sm text-gray-500">{{ percentage|floatformat:0 }}%</span>
              </div>
              {% endfor %}
            </div>

            <!-- Review Form -->
            {% if user.is_authenticated %}
            <form action="{% url 'submit_review' product.id %}" method="POST" class="border-t border-gray-200 pt-8">
              {% csrf_token %}
              <div class="space-y-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Rate this product</label>
                  <div class="star-rating">
                    {% for i in "54321" %}
                    <input type="radio" id="star{{i}}" name="rating" value="{{i}}" {% if forloop.first %}checked{% endif %} />
                    <label for="star{{i}}" class="text-2xl">
                      ★
                    </label>
                    {% endfor %}
                  </div>
                </div>

                <div>
                  <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">Review Title</label>
                  <input 
                    type="text" 
                    name="subject" 
                    id="subject"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    placeholder="Summarize your experience..."
                  >
                </div>

                <div>
                  <label for="review" class="block text-sm font-medium text-gray-700 mb-2">Your Review</label>
                  <textarea 
                    name="review" 
                    id="review"
                    rows="4"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm"
                    placeholder="Share your experience with this product..."
                  ></textarea>
                </div>

                <button 
                  type="submit" 
                  class="w-full yellow-accent-bg yellow-accent-hover text-gray-900 font-bold px-6 py-3 rounded-lg shadow transition duration-300"
                >
                  Submit Review
                </button>
              </div>
            </form>
            {% else %}
            <div class="border-t border-gray-200 pt-8 text-center">
              <p class="text-gray-500 mb-4">Please <a href="{% url 'account_login' %}" class="text-indigo-600 hover:text-indigo-500">sign in</a> to leave a review.</p>
            </div>
            {% endif %}

            <!-- Review List -->
            <div class="mt-8 space-y-8">
              {% for review in reviews %}
              <div class="flex items-start">
                <div class="flex-shrink-0">
                  <img 
                    src="{% if review.user.profile.image %}{{ review.user.profile.image.url }}{% else %}{% static 'images/defaults/user.png' %}{% endif %}" 
                    class="h-12 w-12 rounded-full object-cover"
                    alt="{{review.user.first_name}}"
                    loading="lazy"
                  />
                </div>
                <div class="ml-4 flex-1">
                  <div class="flex items-center justify-between">
                    <span class="font-medium text-gray-900">
                      {{review.user.first_name}} {{review.user.last_name}}
                      {% if review.user.is_staff %}
                      <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                        Verified Buyer
                      </span>
                      {% endif %}
                    </span>
                    <span class="text-sm text-gray-500">{{review.updated_at|timesince}} ago</span>
                  </div>
                  <div class="mt-1 flex items-center space-x-1">
                    {% for i in "12345" %}
                    <svg class="w-4 h-4 {% if forloop.counter <= review.rating %}text-amber-400{% else %}text-gray-300{% endif %}" fill="currentColor" viewBox="0 0 20 20">
                      <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                    </svg>
                    {% endfor %}
                  </div>
                  {% if review.subject %}
                  <h4 class="mt-2 font-medium text-gray-900">{{ review.subject }}</h4>
                  {% endif %}
                  <p class="mt-2 text-gray-600">{{review.review}}</p>
                </div>
              </div>
              {% empty %}
              <div class="text-center py-8">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No reviews yet</h3>
                <p class="mt-1 text-sm text-gray-500">Be the first to review this product</p>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.add('hidden');
    });
    
    // Show selected tab content
    document.getElementById(tabName + '-content').classList.remove('hidden');
    
    // Update active tab styling
    document.querySelectorAll('.product-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.getElementById(tabName + '-tab').classList.add('active');
  }
  
  // Initialize first tab as active
  document.addEventListener('DOMContentLoaded', function() {
    showTab('description');
  });
</script>
{% endblock %}